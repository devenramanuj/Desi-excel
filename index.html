<!DOCTYPE html>
<html lang="gu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic Excel Ultimate</title>
  <style>
    /* 1. ркбрк┐ркЭрк╛ркИрки */
    body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #fff; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
    
    .app-bar { 
      background: #107c41; color: white; padding: 10px; 
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 200;
    }
    .brand { font-weight: bold; font-size: 18px; }

    /* 2. ркЯрлВрк▓ркмрк╛рк░ */
    .toolbar {
      background: #f3f2f1; padding: 8px; border-bottom: 1px solid #e1dfdd;
      display: flex; gap: 6px; overflow-x: auto; align-items: center;
    }
    
    .math-btn {
      background: white; border: 1px solid #ccc; padding: 6px 12px; 
      border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px;
      white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;
    }
    .btn-green { color: #107c41; background: #e6f4ea; border-color: #107c41; }
    .btn-excel { background: #107c41; color: white; border: none; }
    .math-btn:active { transform: scale(0.95); }
    .clear-btn { font-size: 12px; padding: 6px; color: #666; border: 1px solid #999; border-radius: 4px; background: #fff; margin-left: auto; }

    /* 3. ркЬрк╡рк╛ркм рккркЯрлНркЯрлА */
    .fx-bar {
      background: white; padding: 5px; border-bottom: 1px solid #ccc;
      display: flex; align-items: center; gap: 5px; font-size: 14px; color: #444;
    }
    #fx-input { flex-grow: 1; border: none; background: #f3f2f1; padding: 6px; border-radius: 2px; font-weight: bold; color: #107c41; }

    /* 4. ркЧрлНрк░рлАркб (Table) */
    .sheet-wrapper { flex-grow: 1; overflow: auto; position: relative; }
    table { border-collapse: collapse; min-width: 100%; table-layout: fixed; }
    
    th { 
      background: #f8f9fa; border: 1px solid #dcdcdc; height: 35px; 
      text-align: center; color: #555; font-size: 14px; position: sticky; top: 0; z-index: 2;
      position: relative;
    }
    .resizer {
      width: 15px; height: 100%; position: absolute; right: 0; top: 0;
      cursor: col-resize; user-select: none; touch-action: none; display: flex; justify-content: center; align-items: center;
    }
    .resizer::after { content: ""; width: 2px; height: 60%; background: #ccc; }
    
    td { border: 1px solid #e0e0e0; height: 40px; }
    input.cell-input { 
      width: 100%; height: 100%; border: none; outline: none; padding: 0 5px; 
      font-size: 16px; text-align: center; background: transparent; color: #333; font-family: inherit;
    }
    input.cell-input:focus { border: 2px solid #107c41; background: #e6f4ea; font-weight: bold; }
    th:first-child, td:first-child { 
      width: 35px; background: #f3f2f1; position: sticky; left: 0; z-index: 3; font-weight: bold; border-right: 2px solid #ccc; font-size: 12px;
    }
    th:first-child { z-index: 4; }

    /* --- ркирк╡рлБркВ ркорк╛ркИркХ ркмркЯрки (ркЙрккрк░ ркЬркоркгрлА ркмрк╛ркЬрлБ) --- */
    .mic-btn { 
      background: #107c41; color: white; border: none;
      width: 50px; height: 50px; border-radius: 50%; font-size: 24px;
      display: flex; align-items: center; justify-content: center;
      /* рк╣рк╡рлЗ ркЖ рклрк┐ркХрлНрк╕ ркеркИ ркЧркпрлБркВ ркЙрккрк░ */
      position: fixed; 
      top: 135px; /* ркЙрккрк░ркерлА ркЖркЯрк▓рлБркВ ркирлАркЪрлЗ */
      right: 15px; /* ркЬркоркгрлА ркмрк╛ркЬрлБ */
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100;
    }
    .mic-listening { background: #d32f2f; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    /* --- ркХрлНрк░рлЗркбрк┐ркЯ рк▓рк╛ркИрки (Credit Line) --- */
    .credit-footer {
      background: #f1f1f1; text-align: center; padding: 5px;
      font-size: 12px; color: #666; border-top: 1px solid #ddd;
    }
  </style>
</head>
<body>

  <div class="app-bar">
    <div class="brand">ЁЯУК Desi Excel</div>
    <button class="math-btn btn-excel" onclick="downloadExcel()">ЁЯУе Save Excel</button>
  </div>

  <div class="toolbar">
    <button class="math-btn btn-green" onclick="calculate('col_sum')">тмЗ ркКркнрлЛ рк╕рк░рк╡рк╛рк│рлЛ</button>
    <button class="math-btn btn-green" onclick="calculate('row_sum')">тЮб ркЖркбрлЛ рк╕рк░рк╡рк╛рк│рлЛ</button>
    <button class="math-btn" style="color:red;" onclick="calculate('sub')">- ркмрк╛ркж</button>
    <button class="math-btn" onclick="calculate('mul')">├Ч</button>
    <button class="math-btn" onclick="calculate('div')">├╖</button>
    <button class="clear-btn" onclick="location.reload()">New</button>
  </div>

  <div class="fx-bar">
    <span>Info:</span>
    <input type="text" id="fx-input" placeholder="ркХрлЛркИ ркЦрк╛ркирк╛ рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ..." readonly>
  </div>

  <div class="sheet-wrapper">
    <table id="grid"></table>
  </div>

  <div class="credit-footer">
    Created by: <b>[ркдркорк╛рк░рлБркВ ркирк╛рко ркЕрк╣рлАркВ рк▓ркЦрлЛ]</b> | Desi Excel App
  </div>

  <button id="micBtn" class="mic-btn" onclick="toggleVoice()">ЁЯОд</button>

  <script>
    let rows = 20;
    let cols = 5; 
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let activeCell = null;
    let colWidths = [40, 90, 90, 90, 90, 90]; 

    function initGrid() {
      const table = document.getElementById('grid');
      let header = `<tr><th style="width:${colWidths[0]}px">#</th>`;
      for(let i=0; i<cols; i++) {
        header += `
          <th style="width:${colWidths[i+1]}px" id="th-${i}">
            <span ondblclick="formatColumn(${i})">${letters[i]}</span>
            <div class="resizer" onmousedown="initResize(event, ${i})" ontouchstart="initResize(event, ${i})"></div>
          </th>`;
      }
      header += `</tr>`;
      table.innerHTML = header;

      for(let r=1; r<=rows; r++) {
        let rowHTML = `<tr><td style="text-align:center;">${r}</td>`;
        for(let c=0; c<cols; c++) {
          let id = `${letters[c]}${r}`;
          rowHTML += `<td><input type="text" class="cell-input col-${c}" id="${id}" onfocus="focusCell(this)"></td>`;
        }
        rowHTML += `</tr>`;
        table.innerHTML += rowHTML;
      }
    }

    function focusCell(el) {
      activeCell = el;
      document.getElementById('fx-input').value = `Cell: ${el.id}`;
    }

    // --- Drag Resize ---
    let startX, startWidth, resizingColIndex;
    function initResize(e, index) {
      let clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      startX = clientX; resizingColIndex = index;
      let th = document.getElementById(`th-${index}`);
      startWidth = th.offsetWidth;
      document.addEventListener('mousemove', doResize); document.addEventListener('mouseup', stopResize);
      document.addEventListener('touchmove', doResize); document.addEventListener('touchend', stopResize);
      e.target.classList.add('resizing'); e.preventDefault();
    }
    function doResize(e) {
      let clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      let diff = clientX - startX;
      let newWidth = startWidth + diff;
      if(newWidth > 30) document.getElementById(`th-${resizingColIndex}`).style.width = newWidth + 'px';
    }
    function stopResize() {
      document.removeEventListener('mousemove', doResize); document.removeEventListener('mouseup', stopResize);
      document.removeEventListener('touchmove', doResize); document.removeEventListener('touchend', stopResize);
      document.querySelectorAll('.resizer').forEach(r => r.classList.remove('resizing'));
    }

    // --- Date Format ---
    function formatColumn(colIndex) {
      let choice = prompt(`ркХрлЛрк▓рко ${letters[colIndex]} ркорк╛ркЯрлЗ:\n1 -> ркдрк╛рк░рлАркЦ (Date)\n2 -> рк▓ркЦрк╛ркг (Text)`);
      if(choice === "1") document.querySelectorAll(`.col-${colIndex}`).forEach(input => input.type = 'date');
      else if(choice === "2") document.querySelectorAll(`.col-${colIndex}`).forEach(input => input.type = 'text');
    }

    // --- Excel Export ---
    function downloadExcel() {
      let csvContent = "data:text/csv;charset=utf-8,";
      let headerArr = [""];
      for(let i=0; i<cols; i++) headerArr.push(letters[i]);
      csvContent += headerArr.join(",") + "\n";
      for(let r=1; r<=rows; r++) {
        let rowArr = [r];
        let hasData = false;
        for(let c=0; c<cols; c++) {
          let val = document.getElementById(`${letters[c]}${r}`).value;
          rowArr.push(`"${val}"`);
          if(val.trim() !== "") hasData = true;
        }
        if(hasData) csvContent += rowArr.join(",") + "\n";
      }
      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "Desi_Excel.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // --- Calculations ---
    function calculate(type) {
      if(!activeCell) return alert("ркЬрк╡рк╛ркм ркорк╛ркЯрлЗ ркЦрк╛ркирлБркВ рк╕рк┐рк▓рлЗркХрлНркЯ ркХрк░рлЛ.");
      let currentId = activeCell.id;
      let colChar = currentId.charAt(0);
      let rowNum = parseInt(currentId.substring(1));
      let colIndex = letters.indexOf(colChar);
      let numbers = []; let result = 0;

      if (type === 'col_sum') {
        for(let i=1; i<rowNum; i++) {
          let val = document.getElementById(`${colChar}${i}`).value;
          let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
        }
        if(numbers.length === 0) return alert("ркЙрккрк░ ркХрлЛркИ рк░ркХрко ркиркерлА.");
        result = numbers.reduce((a, b) => a + b, 0);
      }
      else if (type === 'row_sum') {
        for(let i=0; i<colIndex; i++) {
          let val = document.getElementById(`${letters[i]}${rowNum}`).value;
          let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
        }
        if(numbers.length === 0) return alert("ркбрк╛ркмрлА ркмрк╛ркЬрлБ ркХрлЛркИ рк░ркХрко ркиркерлА.");
        result = numbers.reduce((a, b) => a + b, 0);
      }
      else {
        for(let i=0; i<colIndex; i++) {
           let val = document.getElementById(`${letters[i]}${rowNum}`).value;
           let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
        }
        if(numbers.length < 2) {
           numbers = [];
           for(let i=1; i<rowNum; i++) {
             let val = document.getElementById(`${colChar}${i}`).value;
             let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
           }
        }
        if(numbers.length < 2) return alert("ркЧркгркдрк░рлА ркорк╛ркЯрлЗ ркмрлЗ рк░ркХрко ркЬрлЛркИркП.");
        let last = numbers[numbers.length - 1];
        let secondLast = numbers[numbers.length - 2];
        if (type === 'sub') result = secondLast - last;
        if (type === 'mul') result = secondLast * last;
        if (type === 'div') result = secondLast / last;
      }

      activeCell.value = parseFloat(result.toFixed(2));
      activeCell.style.fontWeight = "bold"; activeCell.style.color = "#107c41";
      document.getElementById('fx-input').value = `ркЬрк╡рк╛ркм: ${result}`;
      speak(`ркЬрк╡рк╛ркм ркЫрлЗ ${result}`);
    }

    // --- Voice Input ---
    function toggleVoice() {
      if(!activeCell) return alert("ркЦрк╛ркирк╛ рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ!");
      const btn = document.getElementById('micBtn');
      if ('webkitSpeechRecognition' in window) {
        let recognition = new webkitSpeechRecognition();
        recognition.lang = 'gu-IN';
        recognition.start();
        btn.classList.add("mic-listening");
        recognition.onresult = function(event) {
          let text = event.results[0][0].transcript.toLowerCase();
          btn.classList.remove("mic-listening");
          let mathStr = text.replace(/рк╡ркдрлНркдрк╛/g, "+").replace(/ркУркЫрк╛/g, "-").replace(/ркЧрлБркгрлНркпрк╛/g, "*").replace(/ркнрк╛ркЧрлНркпрк╛/g, "/").replace(/ /g, "");
          if (mathStr.includes("+") || mathStr.includes("-") || mathStr.includes("*") || mathStr.includes("/")) {
             try { activeCell.value = eval(mathStr); } catch(e) { activeCell.value = text; }
          } else { activeCell.value = text; }
        };
        recognition.onerror = function() { btn.classList.remove("mic-listening"); };
      } else { alert("Mic Not Supported"); }
    }
    
    function speak(text) { if ('speechSynthesis' in window) { let msg = new SpeechSynthesisUtterance(text); msg.lang = 'gu-IN'; window.speechSynthesis.speak(msg); } }

    initGrid();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="gu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Magic Excel Export</title>
  <style>
    /* 1. ркбрк┐ркЭрк╛ркИрки */
    body { font-family: sans-serif; margin: 0; padding: 0; background: #fff; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
    
    .app-bar { 
      background: #107c41; color: white; padding: 10px; 
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .brand { font-weight: bold; font-size: 18px; }

    /* 2. ркЯрлВрк▓ркмрк╛рк░ */
    .toolbar {
      background: #f3f2f1; padding: 8px; border-bottom: 1px solid #e1dfdd;
      display: flex; gap: 6px; overflow-x: auto; align-items: center;
    }
    
    /* ркмркЯркирлНрк╕ */
    .math-btn {
      background: white; border: 1px solid #ccc; padding: 6px 10px; 
      border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 15px;
      white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .btn-green { color: #107c41; border-color: #107c41; background: #e6f4ea; }
    .btn-excel { background: #107c41; color: white; border: none; } /* ркПркХрлНрк╕рлЗрк▓ ркбрк╛ркЙркирк▓рлЛркб ркмркЯрки */

    .math-btn:active { transform: scale(0.95); }

    .clear-btn { font-size: 13px; padding: 6px; color: #666; border: 1px solid #999; border-radius: 4px; background: #fff; margin-left: auto; }

    /* 3. рк╕рлНркЯрлЗркЯрк╕ */
    .fx-bar {
      background: white; padding: 5px; border-bottom: 1px solid #ccc;
      display: flex; align-items: center; gap: 5px; font-size: 14px; color: #444;
    }
    #fx-input { flex-grow: 1; border: none; background: #f3f2f1; padding: 6px; border-radius: 2px; font-weight: bold; color: #107c41; }

    /* 4. ркЧрлНрк░рлАркб */
    .sheet-wrapper { flex-grow: 1; overflow: auto; position: relative; }
    table { border-collapse: collapse; min-width: 100%; table-layout: fixed; }
    
    th { 
      background: #f8f9fa; border: 1px solid #dcdcdc; height: 35px; 
      text-align: center; color: #555; font-size: 14px; position: sticky; top: 0; z-index: 2;
    }
    td { border: 1px solid #e0e0e0; height: 40px; min-width: 80px; }
    
    input.cell-input { 
      width: 100%; height: 100%; border: none; outline: none; padding: 0 5px; 
      font-size: 18px; text-align: center; background: transparent; color: #333;
    }
    input.cell-input:focus { 
      border: 2px solid #107c41; background: #e6f4ea; font-weight: bold;
    }
    
    th:first-child, td:first-child { 
      width: 35px; background: #f3f2f1; position: sticky; left: 0; z-index: 3; font-weight: bold; border-right: 2px solid #ccc; font-size: 12px;
    }
    th:first-child { z-index: 4; }

    /* ркорк╛ркИркХ */
    .mic-btn { 
      background: #107c41; color: white; border: none;
      width: 55px; height: 55px; border-radius: 50%; font-size: 28px;
      display: flex; align-items: center; justify-content: center;
      position: fixed; bottom: 25px; right: 25px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 100;
    }
    .mic-listening { background: #d32f2f; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  </style>
</head>
<body>

  <div class="app-bar">
    <div class="brand">ЁЯУК Desi Excel</div>
    <button class="math-btn btn-excel" onclick="downloadExcel()">ЁЯУе Save as Excel</button>
  </div>

  <div class="toolbar">
    <button class="math-btn btn-green" onclick="calculate('col_sum')">тмЗ ркКркнрлЛ рк╕рк░рк╡рк╛рк│рлЛ</button>
    <button class="math-btn btn-green" onclick="calculate('row_sum')">тЮб ркЖркбрлЛ рк╕рк░рк╡рк╛рк│рлЛ</button>
    <button class="math-btn" style="color:red;" onclick="calculate('sub')">- ркмрк╛ркж</button>
    <button class="math-btn" onclick="calculate('mul')">├Ч</button>
    <button class="math-btn" onclick="calculate('div')">├╖</button>
    <button class="clear-btn" onclick="location.reload()">New</button>
  </div>

  <div class="fx-bar">
    <span>ркЬрк╡рк╛ркм:</span>
    <input type="text" id="fx-input" placeholder="ркЕрк╣рлАркВ ркжрлЗркЦрк╛рк╢рлЗ..." readonly>
  </div>

  <div class="sheet-wrapper">
    <table id="grid"></table>
  </div>

  <button id="micBtn" class="mic-btn" onclick="toggleVoice()">ЁЯОд</button>

  <script>
    let rows = 20;
    let cols = 5; 
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let activeCell = null;

    function initGrid() {
      const table = document.getElementById('grid');
      let header = `<tr><th>#</th>`;
      for(let i=0; i<cols; i++) header += `<th>${letters[i]}</th>`;
      header += `</tr>`;
      table.innerHTML = header;

      for(let r=1; r<=rows; r++) {
        let rowHTML = `<tr><td style="text-align:center;">${r}</td>`;
        for(let c=0; c<cols; c++) {
          let id = `${letters[c]}${r}`;
          rowHTML += `<td><input type="text" class="cell-input" id="${id}" onfocus="focusCell(this)"></td>`;
        }
        rowHTML += `</tr>`;
        table.innerHTML += rowHTML;
      }
    }

    function focusCell(el) {
      activeCell = el;
      document.getElementById('fx-input').value = `Cell: ${el.id}`;
    }

    // --- ркПркХрлНрк╕рлЗрк▓ ркбрк╛ркЙркирк▓рлЛркб ркХрк░рк╡рк╛ркирлБркВ ркирк╡рлБркВ рклркВркХрлНрк╢рки ---
    function downloadExcel() {
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // рк╣рлЗркбрк░ рк▓рк╛ркИрки
      let headerArr = [""];
      for(let i=0; i<cols; i++) headerArr.push(letters[i]);
      csvContent += headerArr.join(",") + "\n";

      // ркбрлЗркЯрк╛ рк▓рк╛ркИрки
      for(let r=1; r<=rows; r++) {
        let rowArr = [r]; // рк░рлЛ ркиркВркмрк░
        let hasData = false;
        for(let c=0; c<cols; c++) {
          let val = document.getElementById(`${letters[c]}${r}`).value;
          // ркХрлЛркорк╛ рк╣рлЛркп ркдрлЛ ркбркмрк▓ ркХрлЛркЯркорк╛ркВ ркорлВркХрлЛ
          rowArr.push(`"${val}"`);
          if(val.trim() !== "") hasData = true;
        }
        // ркЦрк╛рк▓рлА рк▓рк╛ркИркирлЛ рки рк▓рлЗрк╡рлА рк╣рлЛркп ркдрлЛ ркЖ ркХркирлНркбрк┐рк╢рки рк░рк╛ркЦрлЛ, ркЕркдрлНркпрк╛рк░рлЗ ркмркзрлА рк▓ркИркП ркЫрлАркП
        if(hasData) csvContent += rowArr.join(",") + "\n";
      }

      // ркбрк╛ркЙркирк▓рлЛркб рк▓рк┐ркВркХ ркмркирк╛рк╡рлЛ
      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "maro_hisab.csv"); // рклрк╛ркИрк▓ркирлБркВ ркирк╛рко
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      alert("рклрк╛ркИрк▓ ркбрк╛ркЙркирк▓рлЛркб ркеркИ ркЧркИ! рк╣рк╡рлЗ ркдркорлЗ ркдрлЗркирлЗ ркЕрк╕рк▓рлА Excel ркПрккркорк╛ркВ ркЦрлЛрк▓рлА рк╢ркХрлЛ ркЫрлЛ.");
    }

    // --- ркЧркгркдрк░рлА (ркЬрлВркирлБркВ рк▓рлЛркЬрлАркХ) ---
    function calculate(type) {
      if(!activeCell) return alert("рккрк╣рлЗрк▓рк╛ ркЬрк╡рк╛ркм ркХрлНркпрк╛ркВ рк▓ркЦрк╡рлЛ ркЫрлЗ ркдрлЗ ркЦрк╛ркирк╛ рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ.");
      let currentId = activeCell.id;
      let colChar = currentId.charAt(0);
      let rowNum = parseInt(currentId.substring(1));
      let colIndex = letters.indexOf(colChar);
      let numbers = []; let result = 0;

      if (type === 'col_sum') {
        for(let i=1; i<rowNum; i++) {
          let val = document.getElementById(`${colChar}${i}`).value;
          let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
        }
        if(numbers.length === 0) return alert("ркЙрккрк░ ркХрлЛркИ рк░ркХрко ркиркерлА!");
        result = numbers.reduce((a, b) => a + b, 0);
      }
      else if (type === 'row_sum') {
        for(let i=0; i<colIndex; i++) {
          let val = document.getElementById(`${letters[i]}${rowNum}`).value;
          let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
        }
        if(numbers.length === 0) return alert("ркбрк╛ркмрлА ркмрк╛ркЬрлБ ркХрлЛркИ рк░ркХрко ркиркерлА!");
        result = numbers.reduce((a, b) => a + b, 0);
      }
      else {
        // ркЖркбрк╛ ркмрлЗ ркЖркВркХркбрк╛
        for(let i=0; i<colIndex; i++) {
           let val = document.getElementById(`${letters[i]}${rowNum}`).value;
           let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
        }
        // ркЬрлЛ ркЖркбрк╛ рки ркорк│рлЗ ркдрлЛ ркКркнрк╛ ркмрлЗ ркЖркВркХркбрк╛
        if(numbers.length < 2) {
           numbers = [];
           for(let i=1; i<rowNum; i++) {
             let val = document.getElementById(`${colChar}${i}`).value;
             let n = parseFloat(val); if(!isNaN(n)) numbers.push(n);
           }
        }
        if(numbers.length < 2) return alert("ркЧркгркдрк░рлА ркорк╛ркЯрлЗ ркмрлЗ рк░ркХрко ркЬрлЛркИркП.");
        let last = numbers[numbers.length - 1];
        let secondLast = numbers[numbers.length - 2];
        if (type === 'sub') result = secondLast - last;
        if (type === 'mul') result = secondLast * last;
        if (type === 'div') result = secondLast / last;
      }

      activeCell.value = parseFloat(result.toFixed(2));
      activeCell.style.color = "#107c41"; activeCell.style.fontWeight = "bold";
      document.getElementById('fx-input').value = `ркЬрк╡рк╛ркм: ${result}`;
      speak(`ркЬрк╡рк╛ркм ркЫрлЗ ${result}`);
    }

    function toggleVoice() {
      if(!activeCell) return alert("ркЦрк╛ркирк╛ рккрк░ ркХрлНрк▓рк┐ркХ ркХрк░рлЛ!");
      const btn = document.getElementById('micBtn');
      if ('webkitSpeechRecognition' in window) {
        let recognition = new webkitSpeechRecognition();
        recognition.lang = 'gu-IN';
        recognition.start();
        btn.classList.add("mic-listening");
        recognition.onresult = function(event) {
          let text = event.results[0][0].transcript.toLowerCase();
          btn.classList.remove("mic-listening");
          let mathStr = text.replace(/рк╡ркдрлНркдрк╛/g, "+").replace(/ркУркЫрк╛/g, "-").replace(/ркЧрлБркгрлНркпрк╛/g, "*").replace(/ркнрк╛ркЧрлНркпрк╛/g, "/").replace(/ /g, "");
          if (mathStr.includes("+") || mathStr.includes("-") || mathStr.includes("*") || mathStr.includes("/")) {
             try { activeCell.value = eval(mathStr); } catch(e) { activeCell.value = text; }
          } else { activeCell.value = text; }
        };
        recognition.onerror = function() { btn.classList.remove("mic-listening"); };
      } else { alert("Mic Not Supported"); }
    }
    function speak(text) { if ('speechSynthesis' in window) { let msg = new SpeechSynthesisUtterance(text); msg.lang = 'gu-IN'; window.speechSynthesis.speak(msg); } }
    initGrid();
  </script>
</body>
</html>
